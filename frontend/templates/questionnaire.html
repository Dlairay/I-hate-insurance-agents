<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insurance Questionnaire - Clearcover</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-image: url('/static/images/background_img.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header */
        .header {
            background: transparent;
            padding: 1.5rem 2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .logo-container img {
            height: 40px;
            width: 40px;
        }
        
        .logo-text {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
        }
        
        /* Main Content */
        .main-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        
        .content-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(15px);
            border-radius: 30px;
            padding: 3rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: none;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        /* Progress Steps */
        .progress-steps {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 3rem;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            flex: 1;
        }
        
        .step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 30px;
            left: calc(50% + 30px);
            width: calc(100% - 60px);
            height: 3px;
            background: #ddd;
            z-index: -1;
        }
        
        .step.active::after,
        .step.completed::after {
            background: #5ECDB9;
        }
        
        .step-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.5rem;
            border: 3px solid #ddd;
            font-size: 1.5rem;
            overflow: hidden;
        }
        
        .step-icon img {
            width: 30px;
            height: 30px;
            object-fit: contain;
        }
        
        .step.active .step-icon {
            background: #5ECDB9;
            border-color: #5ECDB9;
            color: white;
        }
        
        .step.completed .step-icon {
            background: #28a745;
            border-color: #28a745;
            color: white;
        }
        
        .step.completed .step-icon img {
            width: 25px;
            height: 25px;
        }
        
        .step-label {
            font-size: 0.8rem;
            color: #999;
            text-align: center;
            line-height: 1.3;
        }
        
        .step.active .step-label {
            color: #333;
            font-weight: 600;
        }
        
        .step.completed .step-label {
            color: #5ECDB9;
        }
        
        /* Content Text */
        .content-title {
            font-size: 1.3rem;
            color: #333;
            margin-bottom: 2rem;
            line-height: 1.5;
        }
        
        /* Singpass Button */
        .singpass-container {
            margin: 2rem 0;
        }
        
        .singpass-btn {
            background: white;
            border: 2px solid #E53E3E;
            border-radius: 8px;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
            text-decoration: none;
        }
        
        .singpass-btn:hover {
            background: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .singpass-text {
            color: #E53E3E;
        }
        
        /* Links */
        .skip-link,
        .info-link {
            color: #666;
            text-decoration: underline;
            font-size: 0.9rem;
            cursor: pointer;
            margin: 1rem 0;
            display: block;
        }
        
        .skip-link:hover,
        .info-link:hover {
            color: #333;
        }
        
        /* Upload PDF Screen */
        .upload-pdf-container {
            display: none;
        }
        
        .upload-section {
            margin: 2rem 0;
        }
        
        .upload-icon-container {
            margin: 2rem 0;
            font-size: 4rem;
            color: #666;
        }
        
        .upload-icon-container img {
            width: 100px;
            height: 100px;
        }
        
        .upload-btn {
            background: #5ECDB9;
            color: white;
            border: none;
            border-radius: 25px;
            padding: 0.8rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 1rem 0;
        }
        
        .upload-btn:hover {
            background: #4DB8A3;
            transform: translateY(-2px);
        }
        
        /* Question Screen Styles */
        .question-container {
            display: none;
        }
        
        .question-content {
            text-align: left;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .question-number {
            color: #5ECDB9;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .question-text {
            font-size: 1.3rem;
            color: #333;
            margin-bottom: 2rem;
            font-weight: 600;
        }
        
        .answer-options {
            margin-bottom: 2rem;
        }
        
        .answer-option {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .answer-option:hover {
            border-color: #5ECDB9;
            background: #f8fffe;
        }
        
        .answer-option.selected {
            border-color: #5ECDB9;
            background: #f0fffc;
        }
        
        .answer-option input[type="radio"] {
            width: 20px;
            height: 20px;
            margin: 0;
        }
        
        .answer-option label {
            flex: 1;
            cursor: pointer;
            font-size: 1rem;
            color: #333;
        }
        
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem;
        }
        
        .nav-btn {
            background: #5ECDB9;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.8rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .nav-btn:hover {
            background: #4DB8A3;
        }
        
        .nav-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .back-btn {
            background: transparent;
            color: #666;
            border: 2px solid #ddd;
        }
        
        .back-btn:hover {
            background: #f8f9fa;
            color: #333;
        }
        
        /* MCQ Screen Styles */
        .mcq-container {
            display: none;
        }
        
        .mcq-content {
            display: flex;
            gap: 2rem;
            text-align: left;
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .question-section {
            flex: 1;
        }
        
        .back-btn {
            background: #5ECDB9;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-bottom: 2rem;
            transition: all 0.3s;
        }
        
        .back-btn:hover {
            background: #4DB8A3;
        }
        
        .question-title {
            font-size: 1.3rem;
            color: #333;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        
        .question-subtitle {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 2rem;
        }
        
        .option {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
        }
        
        .option input[type="radio"] {
            width: 20px;
            height: 20px;
            margin: 0;
        }
        
        .option label {
            font-size: 1rem;
            color: #333;
            cursor: pointer;
        }
        
        /* Chatbot */
        .chatbot-section {
            flex: 1;
            max-width: 400px;
        }
        
        .chatbot {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            height: 400px;
            display: flex;
            flex-direction: column;
        }
        
        .chatbot-header {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 1rem;
        }
        
        .chat-message {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 0.8rem 1rem;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: #666;
        }
        
        .chat-input-container {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .chat-input {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: #5ECDB9;
        }
        
        .chat-send {
            background: #5ECDB9;
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .chat-send:hover {
            background: #4DB8A3;
        }
        
        
        @media (max-width: 768px) {
            .progress-steps {
                gap: 1rem;
            }
            
            .step:not(:last-child)::after {
                width: 40px;
                left: 40px;
            }
            
            .step-icon {
                width: 50px;
                height: 50px;
            }
            
            .mcq-content {
                flex-direction: column;
            }
            
            .content-card {
                padding: 2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo-container">
            <img src="/static/images/logo.png" alt="Clearcover">
            <span class="logo-text">Clearcover</span>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-container">
        <!-- Start Screen -->
        <div class="content-card" id="startScreen">
            <!-- Progress Steps -->
            <div class="progress-steps">
                <div class="step active" id="step1">
                    <div class="step-icon">
                        <img src="/static/images/docs_1.png" alt="Upload Documents" id="icon1">
                    </div>
                    <div class="step-label">Upload Documents</div>
                </div>
                
                <div class="step" id="step2">
                    <div class="step-icon">
                        <img src="/static/images/consultation 1.png" alt="Consultation" id="icon2">
                    </div>
                    <div class="step-label">Consultation</div>
                </div>
                
                <div class="step" id="step3">
                    <div class="step-icon">
                        <img src="/static/images/progress_bar_selection.png" alt="Choose your plan" id="icon3">
                    </div>
                    <div class="step-label">Choose your plan</div>
                </div>
            </div>
            
            <!-- Content -->
            <div class="content-title">
                Log in with Singpass to help us access your medical and insurance records securely and quickly.
            </div>
            
            <div class="singpass-container">
                <input type="file" id="jsonUpload" style="display: none;" accept=".json">
                <img src="/static/images/loginwithsingpass.png" alt="Log in with Singpass" style="cursor: pointer; max-width: 300px;" onclick="document.getElementById('jsonUpload').click()">
            </div>
            
            <div class="skip-link" onclick="skipToManual()">
                Upload documents manually? Skip first
            </div>
            
            <div class="info-link" onclick="showInfo()">
                Why does Clearcover require access to my Singpass?
            </div>
        </div>
        
        <!-- Question Screen -->
        <div class="content-card question-container" id="questionScreen">
            <!-- Progress Steps -->
            <div class="progress-steps">
                <div class="step completed" id="step1q">
                    <div class="step-icon">
                        <img src="/static/images/tick_3.png" alt="Completed" id="icon1q">
                    </div>
                    <div class="step-label">Upload Documents</div>
                </div>
                
                <div class="step active" id="step2q">
                    <div class="step-icon">
                        <img src="/static/images/consultation 1.png" alt="Consultation" id="icon2q">
                    </div>
                    <div class="step-label">Consultation</div>
                </div>
                
                <div class="step" id="step3q">
                    <div class="step-icon">
                        <img src="/static/images/progress_bar_selection.png" alt="Choose your plan" id="icon3q">
                    </div>
                    <div class="step-label">Choose your plan</div>
                </div>
            </div>
            
            <!-- Question Content -->
            <div class="question-content">
                <div class="question-number" id="questionNumber">Question 1 of 25</div>
                <div class="question-text" id="questionText">Loading question...</div>
                
                <div class="answer-options" id="answerOptions">
                    <!-- Options will be populated by JavaScript -->
                </div>
                
                <div class="navigation-buttons">
                    <button class="nav-btn back-btn" id="backBtn" onclick="previousQuestion()" disabled>Back</button>
                    <button class="nav-btn" id="nextBtn" onclick="nextQuestion()" disabled>Next</button>
                </div>
            </div>
        </div>
        
        <!-- Upload PDF Screen -->
        <div class="content-card upload-pdf-container" id="uploadPdfScreen">
            <!-- Progress Steps -->
            <div class="progress-steps">
                <div class="step active">
                    <div class="step-icon">üìã</div>
                    <div class="step-label">STEP 1<br>Upload Documents</div>
                </div>
                
                <div class="step">
                    <div class="step-icon">üë§</div>
                    <div class="step-label">STEP 2<br>Consultation</div>
                </div>
                
                <div class="step">
                    <div class="step-icon">üìä</div>
                    <div class="step-label">STEP 3<br>Choose your plan</div>
                </div>
            </div>
            
            <!-- Content -->
            <div class="content-title">
                Help us serve you better, upload any existing insurance documents you have.
            </div>
            
            <div class="upload-icon-container">
                <img src="/static/images/upload_docs_icon.png" alt="Upload Documents">
            </div>
            
            <div class="upload-section">
                <input type="file" id="pdfUpload" style="display: none;" accept=".pdf" multiple>
                <button class="upload-btn" onclick="document.getElementById('pdfUpload').click()">
                    Upload documents
                </button>
            </div>
            
            <div class="skip-link" onclick="skipPdfUpload()">
                Skip first
            </div>
        </div>
        
        <!-- MCQ Screen -->
        <div class="content-card mcq-container" id="mcqScreen">
            <!-- Progress Steps -->
            <div class="progress-steps">
                <div class="step completed">
                    <div class="step-icon">‚úì</div>
                    <div class="step-label">Upload Documents</div>
                </div>
                
                <div class="step active">
                    <div class="step-icon">üë§</div>
                    <div class="step-label">STEP 2<br>Consultation</div>
                </div>
                
                <div class="step">
                    <div class="step-icon">üìä</div>
                    <div class="step-label">Choose your plan</div>
                </div>
            </div>
            
            <!-- MCQ Content -->
            <div class="mcq-content">
                <div class="question-section">
                    <button class="back-btn" onclick="goBack()">‚Üê</button>
                    
                    <div class="question-title" id="questionTitle">
                        Do you regularly participate in high-risk activities?
                    </div>
                    
                    <div class="question-subtitle">
                        (Feel free to reach out to chatbot on the bottom right if you need any clarifications)
                    </div>
                    
                    <div class="options" id="questionOptions">
                        <div class="option">
                            <input type="radio" name="answer" value="yes" id="yes">
                            <label for="yes">Yes</label>
                        </div>
                        <div class="option">
                            <input type="radio" name="answer" value="no" id="no">
                            <label for="no">No</label>
                        </div>
                    </div>
                </div>
                
                <div class="chatbot-section">
                    <div class="chatbot">
                        <div class="chatbot-header">Chatbot</div>
                        <div class="chat-messages" id="chatMessages">
                            <div class="chat-message">
                                How may I help you today?
                            </div>
                        </div>
                        <div class="chat-input-container">
                            <input type="text" class="chat-input" placeholder="Type something..." id="chatInput">
                            <button class="chat-send" onclick="sendMessage()">üé§</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    
    <script>
        // Questionnaire state
        let currentSessionId = null;
        let currentQuestionIndex = 0;
        let questions = [];
        let answers = {};
        
        function skipToManual() {
            // Skip JSON upload but still show PDF upload
            showUploadPdfScreen();
        }
        
        function startQuestionnaire() {
            // Start the actual questionnaire
            document.getElementById('uploadPdfScreen').style.display = 'none';
            document.getElementById('questionScreen').style.display = 'block';
            
            // Initialize questionnaire session
            initializeSession();
        }
        
        function showUploadPdfScreen() {
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('uploadPdfScreen').style.display = 'block';
        }
        
        function skipPdfUpload() {
            startQuestionnaire();
        }
        
        // Backend API functions
        async function initializeSession() {
            console.log('DEBUG: Starting session initialization...');
            try {
                let endpoint = 'http://localhost:8001/api/start-session';
                let requestBody = {};
                
                // If we have uploaded profile data, use the profile endpoint
                if (window.uploadedProfile) {
                    endpoint = 'http://localhost:8001/api/start-session-with-profile';
                    requestBody = window.uploadedProfile;
                    console.log('DEBUG: Using profile data:', requestBody);
                }
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('DEBUG: Session response:', data);
                    currentSessionId = data.session_id;
                    
                    // The start-session endpoint already returns the first question
                    if (data.current_question) {
                        console.log('DEBUG: Displaying first question:', data.current_question);
                        displayQuestion(data.current_question);
                    } else {
                        console.error('No questions available in response:', data);
                    }
                } else {
                    console.error('Failed to initialize session, status:', response.status);
                }
            } catch (error) {
                console.error('Error initializing session:', error);
            }
        }
        
        function displayQuestion(question) {
            console.log('DEBUG: displayQuestion called with:', question);
            
            // Update question number and text
            document.getElementById('questionNumber').textContent = `Question ${currentQuestionIndex + 1} of 15`;
            document.getElementById('questionText').textContent = question.question_text;
            
            const optionsContainer = document.getElementById('answerOptions');
            optionsContainer.innerHTML = '';
            
            // Handle different question types
            if ((question.question_type === 'MCQ_SINGLE' || question.question_type === 'mcq_single') && question.options && question.options.length > 0) {
                // Single choice MCQ question
                question.options.forEach((option, index) => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'answer-option';
                    optionDiv.onclick = () => selectOption(option.value || option.label, optionDiv);
                    
                    optionDiv.innerHTML = `
                        <input type="radio" name="answer" value="${option.value || option.label}" id="option_${index}">
                        <label for="option_${index}">${option.label || option.text}</label>
                    `;
                    
                    optionsContainer.appendChild(optionDiv);
                });
                
            } else if ((question.question_type === 'MCQ_MULTIPLE' || question.question_type === 'mcq_multiple') && question.options && question.options.length > 0) {
                // Multiple choice MCQ question
                question.options.forEach((option, index) => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'answer-option';
                    optionDiv.onclick = () => selectMultipleOption(option.value || option.label, optionDiv);
                    
                    optionDiv.innerHTML = `
                        <input type="checkbox" name="answer" value="${option.value || option.label}" id="option_${index}">
                        <label for="option_${index}">${option.label || option.text}</label>
                    `;
                    
                    optionsContainer.appendChild(optionDiv);
                });
                
            } else {
                // Text input question (TEXT, NUMBER, DATE, etc.)
                const inputDiv = document.createElement('div');
                inputDiv.className = 'answer-option';
                
                let inputType = 'text';
                let placeholder = question.help_text || 'Enter your answer';
                
                if (question.question_type === 'NUMBER') {
                    inputType = 'number';
                } else if (question.question_type === 'DATE') {
                    inputType = 'date';
                } else if (question.question_type === 'EMAIL') {
                    inputType = 'email';
                }
                
                inputDiv.innerHTML = `
                    <input type="${inputType}" class="form-control" id="textAnswer" placeholder="${placeholder}" style="width: 100%; padding: 0.8rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                `;
                optionsContainer.appendChild(inputDiv);
                
                // Enable next button when user types
                const textInput = inputDiv.querySelector('input');
                textInput.addEventListener('input', () => {
                    document.getElementById('nextBtn').disabled = !textInput.value.trim();
                });
            }
            
            // Update navigation buttons
            document.getElementById('backBtn').disabled = currentQuestionIndex === 0;
            document.getElementById('nextBtn').disabled = true;
        }
        
        function selectOption(optionId, optionElement) {
            // Remove selected class from all options
            document.querySelectorAll('.answer-option').forEach(opt => opt.classList.remove('selected'));
            
            // Add selected class to clicked option
            optionElement.classList.add('selected');
            
            // Check the radio button
            const radio = optionElement.querySelector('input[type="radio"]');
            if (radio) radio.checked = true;
            
            // Enable next button
            document.getElementById('nextBtn').disabled = false;
        }
        
        function selectMultipleOption(optionId, optionElement) {
            // Toggle selected class for clicked option
            optionElement.classList.toggle('selected');
            
            // Toggle the checkbox
            const checkbox = optionElement.querySelector('input[type="checkbox"]');
            if (checkbox) checkbox.checked = !checkbox.checked;
            
            // Enable next button if at least one option is selected
            const selectedCheckboxes = document.querySelectorAll('input[type="checkbox"]:checked');
            document.getElementById('nextBtn').disabled = selectedCheckboxes.length === 0;
        }
        
        async function nextQuestion() {
            const selectedAnswer = getSelectedAnswer();
            if (!selectedAnswer) return;
            
            try {
                const response = await fetch(`http://localhost:8001/api/session/${currentSessionId}/answer`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        answer: selectedAnswer
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.completed) {
                        // Questionnaire completed, show results
                        showResults(data);
                    } else if (data.next_question) {
                        // Show next question (backend handles skipping logic)
                        currentQuestionIndex++;
                        displayQuestion(data.next_question);
                    } else {
                        console.error('No next question available');
                    }
                } else {
                    console.error('Failed to submit answer');
                }
            } catch (error) {
                console.error('Error submitting answer:', error);
            }
        }
        
        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                // In a real implementation, you'd fetch the previous question
                // For now, just disable the back button functionality
            }
        }
        
        function getSelectedAnswer() {
            // Check for radio button selection first (MCQ_SINGLE)
            const selectedRadio = document.querySelector('input[type="radio"]:checked');
            if (selectedRadio) {
                return selectedRadio.value;
            }
            
            // Check for checkbox selections (MCQ_MULTIPLE)
            const selectedCheckboxes = document.querySelectorAll('input[type="checkbox"]:checked');
            if (selectedCheckboxes.length > 0) {
                // Return array of selected values for multiple choice
                return Array.from(selectedCheckboxes).map(cb => cb.value);
            }
            
            // Check for text input
            const textInput = document.getElementById('textAnswer');
            if (textInput && textInput.value.trim()) {
                return textInput.value.trim();
            }
            
            // Check for other input types
            const numberInput = document.getElementById('numberAnswer');
            const dateInput = document.getElementById('dateAnswer');
            
            if (numberInput && numberInput.value) return numberInput.value;
            if (dateInput && dateInput.value) return dateInput.value;
            
            return null;
        }
        
        function showResults(data) {
            // Update progress to show completion
            updateProgressToCompleted();
            
            // Hide question screen and redirect to recommendations
            document.getElementById('questionScreen').style.display = 'none';
            
            // Use the redirect URL from the backend if available
            if (data.redirect_to) {
                window.location.href = data.redirect_to;
            } else {
                // Fallback to recommendations page
                window.location.href = `/recommendations?session=${currentSessionId}`;
            }
        }
        
        function updateProgressToCompleted() {
            // Update step 2 to completed
            document.getElementById('step2q').classList.remove('active');
            document.getElementById('step2q').classList.add('completed');
            document.getElementById('icon2q').src = '/static/images/tick_3.png';
            
            // Activate step 3
            document.getElementById('step3q').classList.add('active');
        }
        
        function showInfo() {
            alert('We use Singpass to securely access your medical and insurance records with your consent. This helps us provide you with the most accurate insurance recommendations tailored to your specific needs and health profile. Your data is encrypted and protected at all times.');
        }
        
        function showMCQScreen() {
            document.getElementById('uploadPdfScreen').style.display = 'none';
            document.getElementById('mcqScreen').style.display = 'block';
        }
        
        function goBack() {
            document.getElementById('mcqScreen').style.display = 'none';
            document.getElementById('uploadPdfScreen').style.display = 'block';
        }
        
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const messages = document.getElementById('chatMessages');
            
            if (input.value.trim()) {
                const userMessage = document.createElement('div');
                userMessage.className = 'chat-message';
                userMessage.style.background = '#5ECDB9';
                userMessage.style.color = 'white';
                userMessage.textContent = input.value;
                messages.appendChild(userMessage);
                
                // Simulate bot response
                setTimeout(() => {
                    const botMessage = document.createElement('div');
                    botMessage.className = 'chat-message';
                    botMessage.textContent = 'Thank you for your question. I can help clarify any insurance terms or requirements.';
                    messages.appendChild(botMessage);
                    messages.scrollTop = messages.scrollHeight;
                }, 1000);
                
                input.value = '';
                messages.scrollTop = messages.scrollHeight;
            }
        }
        
        // Allow enter key to send messages
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Handle JSON upload (Singpass simulation)
        document.getElementById('jsonUpload').addEventListener('change', function(e) {
            const files = e.target.files;
            if (files.length > 0) {
                const file = files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const profileData = JSON.parse(e.target.result);
                        console.log('DEBUG: JSON profile data:', profileData);
                        
                        // Store profile data for use in session initialization
                        window.uploadedProfile = profileData;
                        
                        alert('Profile data uploaded successfully! Proceeding to document upload.');
                        setTimeout(() => {
                            showUploadPdfScreen();
                        }, 1000);
                    } catch (error) {
                        console.error('Error parsing JSON file:', error);
                        alert('Error parsing JSON file. Please check the file format.');
                    }
                };
                reader.readAsText(file);
            }
        });
        
        // Handle PDF upload
        document.getElementById('pdfUpload').addEventListener('change', function(e) {
            const files = e.target.files;
            if (files.length > 0) {
                alert(`${files.length} document(s) uploaded successfully! Proceeding to consultation.`);
                setTimeout(() => {
                    startQuestionnaire();
                }, 1500);
            }
        });
    </script>
</body>
</html>